# Oracle AWR 报告分析软件 - 产品需求文档 (PRD)

**文档版本**: v1.0
**创建日期**: 2025-10-02
**项目名称**: AWR Report Analyzer
**项目代号**: awrrptanalyzor

---

## 1. 产品概述

### 1.1 产品定位

Oracle AWR 报告分析软件是一款面向 DBA、数据库工程师和运维人员的智能化性能诊断工具。通过自动解析 AWR（Automatic Workload Repository）HTML 报告，提供深度性能分析、智能诊断建议、历史趋势对比和多格式报告导出功能，帮助用户快速定位数据库性能瓶颈并获得专业优化建议。

### 1.2 目标用户

- **主要用户**: Oracle DBA（数据库管理员）
- **次要用户**: 数据库性能工程师、系统架构师、应用开发团队
- **用户规模**: 企业级（支持多用户并发使用）

### 1.3 核心价值

- **效率提升**: 自动化分析替代人工解读，节省 80% 分析时间
- **专业智能**: 内置专家规则库，提供专业级诊断建议
- **历史对比**: 快速识别性能变化趋势和异常
- **标准化**: 统一的分析标准和报告格式

### 1.4 产品目标

- **短期目标 (3个月)**: 支持 Oracle 11g/12c/19c AWR 报告解析，提供核心性能分析和基础诊断功能
- **中期目标 (6个月)**: 完善规则库达到 50+ 诊断规则，支持历史对比和多格式导出
- **长期目标 (12个月)**: 引入机器学习异常检测，支持实时监控集成，用户数达到 1000+

---

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 AWR 报告上传与管理

**功能描述**:
用户可通过 Web 界面上传 AWR HTML 报告文件，系统自动存储并管理历史报告。

**功能详情**:

| 功能点 | 需求描述 | 优先级 |
|--------|----------|--------|
| 文件上传 | 支持拖拽上传和点击选择，单文件最大 50MB | P0 |
| 批量上传 | 支持同时上传多个报告文件（最多 10 个） | P1 |
| 格式校验 | 自动检测文件是否为有效的 AWR HTML 报告 | P0 |
| 进度显示 | 实时显示上传进度和解析状态 | P1 |
| 报告列表 | 以表格形式展示已上传的报告列表 | P0 |
| 搜索过滤 | 支持按数据库名、实例名、时间范围搜索 | P1 |
| 排序功能 | 支持按上传时间、快照时间排序 | P2 |
| 删除功能 | 支持单个或批量删除报告 | P1 |

**验收标准**:
- 上传 10MB HTML 文件在 5 秒内完成
- 支持同时 10 个用户并发上传
- 文件格式错误时给出明确提示

#### 2.1.2 AWR 报告自动解析

**功能描述**:
系统自动识别 Oracle 版本并解析 AWR HTML 报告，提取关键性能指标和统计信息。

**功能详情**:

| 功能点 | 需求描述 | 优先级 |
|--------|----------|--------|
| 版本识别 | 自动识别 Oracle 11g/12c/19c/21c 版本 | P0 |
| 实例信息解析 | 提取数据库名、实例名、主机名、版本号 | P0 |
| 快照信息解析 | 提取开始/结束快照号、时间范围、快照间隔 | P0 |
| Load Profile 解析 | 提取 DB Time、CPU Time、逻辑读、物理读等核心指标 | P0 |
| 等待事件解析 | 提取 Top 等待事件及其时间占比 | P0 |
| SQL 统计解析 | 提取 Top SQL（按 CPU、IO、执行次数等维度） | P0 |
| 内存统计解析 | 提取 SGA/PGA 使用情况 | P1 |
| IO 统计解析 | 提取表空间 IO、数据文件 IO 统计 | P1 |
| Segment 统计解析 | 提取热点对象（表、索引）访问统计 | P2 |
| RAC 支持 | 支持多节点 RAC AWR 报告解析 | P2 |
| CDB/PDB 支持 | 支持 12c+ 容器数据库架构 | P2 |

**支持的 Oracle 版本矩阵**:

| Oracle 版本 | 支持优先级 | 备注 |
|------------|-----------|------|
| 19c | P0 | 最新长期支持版本 |
| 12c (12.1/12.2) | P0 | 企业广泛使用 |
| 11g (11.2) | P1 | 遗留系统仍在使用 |
| 21c/23c | P2 | 未来版本支持 |

**验收标准**:
- 解析成功率 > 95%（针对标准格式 AWR 报告）
- 单个 5MB 报告解析时间 < 10 秒
- 核心指标提取准确率 100%

#### 2.1.3 性能指标可视化展示

**功能描述**:
以图表和表格形式直观展示 AWR 报告中的性能指标。

**功能详情**:

| 展示模块 | 展示内容 | 图表类型 | 优先级 |
|---------|---------|---------|--------|
| 概览仪表盘 | 核心指标卡片（DB Time、CPU、命中率等） | 数字卡片 | P0 |
| Load Profile | 各项负载指标及 per second/per txn 值 | 表格 + 柱状图 | P0 |
| 等待事件分析 | Top 等待事件时间占比和分类 | 饼图 + 表格 | P0 |
| SQL 统计 | Top SQL 列表（可切换维度：CPU/IO/执行次数） | 表格 + 排行榜 | P0 |
| 时间模型 | DB Time 构成分解（CPU vs Wait） | 堆叠柱状图 | P1 |
| 内存使用 | SGA/PGA 各组件使用情况 | 饼图 | P1 |
| IO 统计 | 表空间 IO、读写比例 | 柱状图 + 表格 | P1 |
| 实例效率 | 缓冲区命中率、Library Cache 命中率等 | 仪表盘 | P1 |
| 热点对象 | Top Segment by Logical Reads/Physical Reads | 表格 | P2 |

**交互需求**:
- 图表支持缩放、导出图片
- 表格支持排序、搜索、分页
- 支持数据钻取（点击 SQL_ID 查看详情）

**验收标准**:
- 页面加载时间 < 2 秒
- 图表渲染流畅（60fps）
- 移动端自适应展示

#### 2.1.4 智能性能诊断

**功能描述**:
基于专家规则库自动分析性能数据，识别潜在问题并提供优化建议。

**功能详情**:

| 诊断维度 | 诊断内容示例 | 优先级 |
|---------|-------------|--------|
| CPU 性能 | CPU 使用率过高、硬解析率高、并发度异常 | P0 |
| 内存问题 | Buffer Cache 命中率低、PGA 不足、Shared Pool 碎片化 | P0 |
| IO 瓶颈 | 物理读过高、TEMP 表空间 IO 异常、日志写入慢 | P0 |
| SQL 问题 | 低效 SQL、全表扫描、缺失索引 | P0 |
| 等待事件 | 行锁等待、闩锁争用、网络延迟 | P0 |
| 配置问题 | 参数设置不合理、资源分配不均 | P1 |
| RAC 问题 | 全局缓存争用、节点负载不均 | P2 |

**诊断规则特性**:
- **分级**: Critical（严重）/ High（高）/ Medium（中）/ Low（低）
- **关联**: 多指标联合判断（如 IO 高 + 命中率低 → 可能缺失索引）
- **上下文**: 提供相关指标值和阈值对比
- **可扩展**: 支持通过配置文件添加自定义规则

**建议内容包含**:
1. **问题描述**: 简洁说明问题现象
2. **根因分析**: 解释可能的原因
3. **优化建议**: 具体的操作步骤（SQL 优化、参数调整、架构改进）
4. **参考文档**: 相关 Oracle 官方文档链接（可选）

**验收标准**:
- 基础规则库包含 30+ 诊断规则
- 诊断准确率 > 90%（通过真实案例验证）
- 每个问题必须包含可操作的建议

#### 2.1.5 历史报告对比分析

**功能描述**:
选择两个不同时间点的 AWR 报告进行对比，识别性能变化趋势。

**功能详情**:

| 对比维度 | 对比内容 | 展示方式 | 优先级 |
|---------|---------|---------|--------|
| 负载对比 | DB Time、CPU Time、事务数等核心指标 | 并排柱状图 + 差异百分比 | P0 |
| 等待事件对比 | Top 等待事件时间变化 | 对比表格 + 趋势箭头 | P0 |
| SQL 对比 | 识别新增、消失、性能变化的 SQL | 三列对比表格 | P1 |
| IO 对比 | 读写量、响应时间变化 | 折线图 | P1 |
| 内存对比 | SGA/PGA 使用变化 | 对比柱状图 | P1 |
| 趋势分析 | 多时段（3+ 报告）趋势图 | 时间序列折线图 | P2 |

**对比算法**:
- 计算绝对差异和百分比差异
- 自动高亮显著变化（> ±20%）
- 支持归一化对比（不同时间长度的报告）

**验收标准**:
- 对比结果生成时间 < 3 秒
- 自动标注异常变化点
- 支持导出对比报告

#### 2.1.6 报告导出功能

**功能描述**:
将分析结果导出为多种格式，方便分享和存档。

**功能详情**:

| 导出格式 | 包含内容 | 优先级 |
|---------|---------|--------|
| PDF 报告 | 完整的分析报告（图表 + 表格 + 诊断建议） | P0 |
| Excel 文件 | 多 Sheet：概览、Load Profile、Top SQL、等待事件、诊断结果 | P1 |
| JSON 数据 | 原始解析数据和分析结果（API 导出） | P1 |
| CSV 文件 | 单一维度数据导出（如 Top SQL CSV） | P2 |

**PDF 报告特性**:
- 自动生成封面（数据库信息、快照时间）
- 包含目录和页码
- 保留图表样式
- 支持中文字体
- 文件大小优化（< 5MB）

**Excel 报告特性**:
- 每个维度独立 Sheet
- 保留样式和格式
- 支持数据透视表（可选）

**验收标准**:
- PDF 生成时间 < 10 秒
- Excel 支持 Excel 2010+ 版本
- 导出的数据完整性 100%

### 2.2 辅助功能

#### 2.2.1 用户认证与权限管理

**功能描述** (可选，Phase 2):
支持多用户使用，不同用户权限隔离。

**功能点**:
- 用户注册/登录
- 角色管理（管理员/普通用户）
- 报告权限控制（私有/共享）
- 审计日志

**优先级**: P2（MVP 版本可跳过，使用单用户模式）

#### 2.2.2 系统配置管理

**功能描述**:
管理员可配置系统参数和诊断规则。

**功能点**:
- 诊断规则阈值配置
- 文件上传大小限制配置
- 数据保留策略配置

**优先级**: P2

#### 2.2.3 任务监控

**功能描述**:
实时查看报告解析和分析任务的执行状态。

**功能点**:
- 任务列表（进行中/已完成/失败）
- 进度百分比显示
- 失败任务重试
- 任务日志查看

**优先级**: P1

---

## 3. 非功能需求

### 3.1 性能要求

| 指标 | 目标值 | 优先级 |
|-----|--------|--------|
| 报告上传响应 | < 5 秒（10MB 文件） | P0 |
| 报告解析时间 | < 10 秒（5MB 文件） | P0 |
| 页面加载时间 | < 2 秒（首次加载） | P1 |
| 并发用户支持 | 100 并发用户 | P1 |
| 数据库查询响应 | < 500ms（单次查询） | P1 |
| PDF 生成时间 | < 10 秒 | P1 |

### 3.2 可用性要求

| 指标 | 目标值 |
|-----|--------|
| 系统可用性 | 99.5%（月度） |
| 故障恢复时间 | < 1 小时 |
| 数据备份频率 | 每日一次 |

### 3.3 安全要求

| 需求 | 描述 | 优先级 |
|-----|------|--------|
| 数据传输加密 | HTTPS/TLS 1.2+ | P0 |
| 文件扫描 | 上传文件病毒扫描 | P1 |
| SQL 注入防护 | ORM 参数化查询 | P0 |
| XSS 防护 | 前端输入过滤 | P0 |
| 敏感数据脱敏 | 数据库连接串等敏感信息不展示 | P1 |

### 3.4 兼容性要求

**浏览器支持**:
- Chrome 90+（主要支持）
- Firefox 88+
- Edge 90+
- Safari 14+（基础支持）

**数据库支持**:
- Oracle 11g Release 2 (11.2.0.4)
- Oracle 12c Release 1/2 (12.1.0.2 / 12.2.0.1)
- Oracle 19c (19.3+)
- Oracle 21c / 23c（未来支持）

**部署环境**:
- Linux (Ubuntu 20.04+, CentOS 7+)
- Windows Server 2016+（部分支持）
- Docker 20.10+
- Kubernetes 1.20+（可选）

### 3.5 可扩展性要求

- **横向扩展**: 支持通过增加服务器节点扩展处理能力
- **存储扩展**: 支持对象存储（MinIO/S3）存储大量历史报告
- **规则扩展**: 支持通过配置文件添加新诊断规则，无需修改代码

### 3.6 可维护性要求

- **日志记录**: 完整的系统日志和错误日志
- **监控指标**: 提供 Prometheus 指标接口
- **文档**: 完整的 API 文档和部署文档
- **代码质量**: 单元测试覆盖率 > 70%

---

## 4. 用户场景

### 4.1 场景一：日常性能巡检

**角色**: DBA 张工

**场景描述**:
张工每周一需要检查生产数据库的性能状况。他在周末生成了上周的 AWR 报告。

**操作流程**:
1. 登录系统，点击"上传报告"
2. 拖拽 AWR HTML 文件到上传区域
3. 系统自动解析并显示"解析成功"
4. 点击报告进入详情页，查看概览仪表盘
5. 系统自动显示 5 个诊断问题（2 个高优先级）
6. 张工逐一查看问题描述和优化建议
7. 导出 PDF 报告发送给开发团队

**预期结果**:
- 整个流程 < 5 分钟
- 清晰识别性能问题
- 获得可操作的优化建议

### 4.2 场景二：性能变化对比

**角色**: 高级 DBA 李工

**场景描述**:
系统在上周部署了新版本，李工需要对比部署前后的性能变化。

**操作流程**:
1. 进入"对比分析"页面
2. 选择基线报告（部署前）和目标报告（部署后）
3. 点击"开始对比"
4. 系统展示对比结果，高亮显示：
   - DB Time 增加 35%（红色预警）
   - 出现新的等待事件 "enq: TX - row lock contention"
   - 一个新 SQL 进入 Top 10，消耗 40% CPU
5. 李工点击该 SQL 查看详情，发现是新功能引入的未优化查询
6. 导出对比报告，提交性能问题单

**预期结果**:
- 快速定位新版本引入的性能问题
- 明确性能劣化的根因（具体 SQL）

### 4.3 场景三：故障排查

**角色**: 运维工程师王工

**场景描述**:
凌晨 2 点接到告警：生产数据库响应缓慢。王工生成故障时段的 AWR 报告进行分析。

**操作流程**:
1. 上传故障时段 AWR 报告
2. 系统立即识别严重问题：
   - **Critical**: "等待事件 'db file sequential read' 占用 60% DB Time"
   - **High**: "物理读达到 50000 次/秒（正常为 5000）"
3. 点击查看诊断详情：
   - 根因：可能索引失效或表统计信息过期
   - 建议：检查 Top SQL 是否走错执行计划，重新收集统计信息
4. 查看 Top SQL，发现核心查询未使用索引
5. 立即在数据库执行 `rebuild index`，故障恢复

**预期结果**:
- 5 分钟内定位根因
- 给出明确的解决方向

---

## 5. 数据需求

### 5.1 数据实体

#### 5.1.1 AWR 报告元数据

| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| id | Integer | 主键 | 是 |
| filename | String | 文件名 | 是 |
| file_path | String | 存储路径 | 是 |
| file_size | Integer | 文件大小（字节） | 是 |
| upload_time | Timestamp | 上传时间 | 是 |
| oracle_version | String | Oracle 版本 | 否 |
| db_name | String | 数据库名 | 是 |
| instance_name | String | 实例名 | 是 |
| host_name | String | 主机名 | 否 |
| snapshot_begin | Timestamp | 快照开始时间 | 是 |
| snapshot_end | Timestamp | 快照结束时间 | 是 |
| snapshot_interval | Integer | 快照间隔（分钟） | 是 |
| status | Enum | 状态（pending/parsing/parsed/failed） | 是 |
| error_message | Text | 错误信息 | 否 |

#### 5.1.2 性能指标数据

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Integer | 主键 |
| report_id | Integer | 外键（关联报告） |
| metric_category | String | 指标分类（load_profile/wait_events/sql_stats/io_stats） |
| metric_data | JSONB | 指标数据（灵活存储） |

**metric_data 结构示例** (load_profile):
```json
{
  "db_time": 12345678,
  "cpu_time": 8901234,
  "logical_reads": 9876543210,
  "physical_reads": 123456789,
  "executions": 567890,
  "transactions": 12345
}
```

#### 5.1.3 诊断结果数据

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Integer | 主键 |
| report_id | Integer | 外键（关联报告） |
| rule_id | String | 规则标识 |
| severity | Enum | 严重程度（critical/high/medium/low） |
| category | String | 问题分类（cpu/io/memory/sql/wait_event） |
| issue_title | String | 问题标题 |
| issue_description | Text | 问题描述 |
| recommendation | Text | 优化建议 |
| metric_values | JSONB | 相关指标值 |

### 5.2 数据保留策略

- **报告文件**: 默认保留 90 天，可配置
- **解析数据**: 永久保留（或保留 1 年后归档）
- **诊断结果**: 与报告同生命周期
- **对比结果**: 临时数据，保留 30 天

### 5.3 数据备份策略

- **数据库备份**: 每日全量备份 + 增量备份
- **文件备份**: 每周备份到对象存储
- **备份保留**: 备份保留 30 天

---

## 6. 界面设计要求

### 6.1 设计风格

- **风格**: 现代企业级风格，简洁专业
- **色系**: 蓝色主色调（科技感），红色警告色
- **布局**: 响应式布局，适配桌面和平板

### 6.2 核心页面

#### 6.2.1 首页 / 上传页面

**布局**:
- 顶部导航栏（Logo + 菜单）
- 中心区域：大尺寸上传拖拽区域
- 底部：最近上传的报告列表（5 条）

#### 6.2.2 报告列表页面

**布局**:
- 顶部：搜索框 + 过滤器（数据库名、时间范围）
- 主体：表格展示
  - 列：数据库名、实例名、快照时间、时间范围、状态、操作
  - 操作：查看、对比、删除
- 底部：分页器

#### 6.2.3 报告详情页面

**布局**:
- 顶部：面包屑导航 + 报告基本信息卡片
- 左侧：Tab 导航（概览、Load Profile、等待事件、SQL 统计、内存、IO、诊断）
- 主体：根据 Tab 切换展示不同内容
- 右侧（可选）：快速诊断结果侧边栏

#### 6.2.4 智能诊断页面

**布局**:
- 顶部：诊断摘要（严重问题数量统计）
- 主体：问题卡片列表
  - 每个卡片：严重程度标签 + 问题标题 + 展开查看详情按钮
  - 展开后：问题描述 + 相关指标 + 优化建议
- 底部：导出诊断报告按钮

#### 6.2.5 对比分析页面

**布局**:
- 顶部：报告选择器（基线 vs 目标）
- 主体：并排对比视图
  - 核心指标对比卡片
  - 等待事件对比表格
  - SQL 对比表格
  - 趋势图表
- 底部：导出对比报告按钮

### 6.3 交互设计要点

- **反馈及时**: 所有操作提供即时反馈（loading 状态、成功/失败提示）
- **错误友好**: 错误信息清晰，提供解决建议
- **快捷操作**: 支持键盘快捷键（如 Ctrl+U 上传）
- **引导提示**: 首次使用显示功能引导

---

## 7. 技术约束

### 7.1 技术选型

- **后端**: Python 3.11+ + FastAPI
- **前端**: React 18 + TypeScript + Ant Design Pro
- **数据库**: PostgreSQL 14+
- **缓存**: Redis 7
- **任务队列**: Celery
- **容器化**: Docker + Docker Compose

### 7.2 开发规范

- **代码风格**: PEP 8 (Python) / ESLint (TypeScript)
- **版本控制**: Git + Semantic Versioning
- **测试要求**: 单元测试覆盖率 > 70%
- **文档要求**: API 文档（OpenAPI）+ 代码注释

---

## 8. 项目计划

### 8.1 开发阶段

| 阶段 | 时间 | 主要交付物 |
|-----|------|-----------|
| **Phase 1: MVP** | 4-6 周 | 基础架构 + 上传 + 19c 解析 + 基本展示 + 简单诊断 |
| **Phase 2: 核心功能** | 6-8 周 | 完整解析 + 完整展示 + 规则引擎 + 对比 + PDF 导出 |
| **Phase 3: 增强功能** | 4-6 周 | Excel/JSON 导出 + RAC + 趋势 + 自定义规则 + 权限 |
| **Phase 4: 优化迭代** | 持续 | 性能优化 + ML 集成 + 移动端 + 国际化 |

### 8.2 里程碑

| 里程碑 | 时间点 | 验收标准 |
|--------|--------|---------|
| M1: MVP 完成 | Week 6 | 支持 19c AWR 基本分析和诊断 |
| M2: 核心功能完成 | Week 14 | 支持 11g/12c/19c，完整诊断和对比功能 |
| M3: Beta 测试 | Week 20 | 内部用户试用，收集反馈 |
| M4: 正式发布 | Week 24 | 通过所有测试，文档完善 |

---

## 9. 风险与挑战

### 9.1 技术风险

| 风险 | 影响 | 概率 | 应对策略 |
|-----|------|------|---------|
| 不同版本 AWR 格式差异大 | 高 | 高 | 建立版本测试样本库，逐版本适配 |
| 大文件解析性能问题 | 中 | 中 | 使用异步任务 + 流式解析 |
| 规则库准确性不足 | 高 | 中 | 邀请资深 DBA 评审规则，持续优化 |

### 9.2 业务风险

| 风险 | 影响 | 概率 | 应对策略 |
|-----|------|------|---------|
| 用户需求理解偏差 | 高 | 中 | 早期邀请目标用户参与设计评审 |
| 市场竞品出现 | 中 | 低 | 快速迭代，建立差异化优势 |

### 9.3 资源风险

| 风险 | 影响 | 概率 | 应对策略 |
|-----|------|------|---------|
| 开发人员不足 | 高 | 中 | 优先实现核心功能，次要功能延后 |
| 测试资源不足 | 中 | 中 | 自动化测试 + 社区用户参与测试 |

---

## 10. 成功指标

### 10.1 产品指标

- **用户数**: 6 个月内达到 100+ 活跃用户
- **报告上传量**: 月均 1000+ 份报告
- **诊断准确率**: > 90%（通过用户反馈验证）

### 10.2 技术指标

- **系统可用性**: > 99.5%
- **平均响应时间**: < 2 秒
- **单元测试覆盖率**: > 70%

### 10.3 用户满意度

- **NPS 评分**: > 50
- **功能满意度**: > 4.0/5.0
- **Bug 率**: < 5% 的报告解析失败

---

## 11. 附录

### 11.1 术语表

| 术语 | 全称 | 说明 |
|-----|------|------|
| AWR | Automatic Workload Repository | Oracle 自动负载仓库，记录数据库性能快照 |
| DBA | Database Administrator | 数据库管理员 |
| Load Profile | 负载概况 | AWR 报告中的核心性能指标汇总 |
| DB Time | Database Time | 数据库服务时间（包含 CPU 和等待时间） |
| Top SQL | - | 资源消耗最多的 SQL 语句排行 |
| RAC | Real Application Clusters | Oracle 多节点集群架构 |
| CDB/PDB | Container/Pluggable Database | Oracle 12c+ 容器数据库架构 |

### 11.2 参考文档

- [Oracle AWR Report 官方文档](https://docs.oracle.com/en/database/oracle/oracle-database/19/tgdba/gathering-database-statistics.html)
- [Oracle Performance Tuning Guide](https://docs.oracle.com/en/database/oracle/oracle-database/19/tgdba/)

---

**文档状态**: 待评审
**责任人**: 产品负责人
**评审人**: 技术负责人、架构师、核心用户代表
